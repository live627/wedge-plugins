<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>live627:topic_fields</id>
	<version>1.0</version>

	<file name="$themedir/Admin.template.php">
		<operation>
			<search position="before"><![CDATA[<option value="theme"', $context['field']['profile_area'] == 'theme' ? ' selected="selected"' : '', '>', $txt['theme'], '</option>]]></search>
			<add><![CDATA[
									<option value="topic"', $context['field']['profile_area'] == 'topic' ? ' selected="selected"' : '', '>', $txt['topic'], '</option>]]></add>
		</operation>
	</file>

	<file name="$themedir/Post.template.php">
		<operation>
			<search position="after"><![CDATA[// Is visual verification enabled?]]></search>
			<add><![CDATA[// Now put the topic fields, if any.
	if (!empty($context['custom_fields']) && $context['is_new_post'])
	{
		echo '
					<div id="topicFieldsHeader">
						<img src="', $settings['images_url'], '/collapse.gif" alt="-" id="topicFieldsExpand" style="display: none;" /> <strong><a href="#" id="topicFieldsExpandLink">', $txt['topic_fields'], '</a></strong>
					</div>
					<div id="topicFields" class="smalltext">
						<dl class="settings">';

		foreach ($context['custom_fields'] as $field)
			echo '
							<dt>
								<strong>', $field['name'], ': </strong><br />
								<span class="smalltext">', $field['desc'], '</span>
							</dt>
							<dd>
								', $field['input_html'], '
							</dd>';

		echo '
						</dl>
					</div>';
	}

	]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[// Code for showing and hiding additional options.]]></search>
			<add><![CDATA[// Code for topic fields toggle.
	global $user_info;
	if (!empty($context['custom_fields']) && $context['is_new_post'])
		echo '
			var oSwapTopicFields = new smc_Toggle({
				bToggleEnabled: true,
				bCurrentlyCollapsed: ', $context['is_topic_fields_collapsed'] ? 'true' : 'false', ',
				aSwappableContainers: [
					\'topicFields\'
				],
				aSwapImages: [
					{
						sId: \'topicFieldsExpand\',
						srcExpanded: smf_images_url + \'/collapse.gif\',
						altExpanded: \'-\',
						srcCollapsed: smf_images_url + \'/expand.gif\',
						altCollapsed: \'+\'
					}
				],
				oThemeOptions: {
					bUseThemeSettings: ' . ($user_info['is_guest'] ? 'false' : 'true') . ',
					sOptionName: \'topicFields\',
					sSessionVar: ' . JavaScriptEscape($context['session_var']) . ',
					sSessionId: ' . JavaScriptEscape($context['session_id']) . '
				},
				oCookieOptions: {
					bUseCookie: ' . ($user_info['is_guest'] ? 'true' : 'false') . ',
					sCookieName: \'topicFields\'
				}
			});';

	]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Post.php">
		<operation>
			<search position="after"><![CDATA[// Finally, load the template.]]></search>
			<add><![CDATA[// Load the topic fields.
	require_once($sourcedir . '/Profile.php');
	loadCustomFields(0, 'topic');
	$context['is_topic_fields_collapsed'] = $user_info['is_guest'] ? !empty($_COOKIE['topicFields']) : !empty($options['topicFields']);

	]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA['approved' => $becomesApproved,]]></search>
			<add><![CDATA[
			'custom_fields' => $_POST['customfield'],]]></add>
		</operation>
	</file>

	<file name="$languagedir/Modifications.english.php">
		<operation>
			<search position="end" />
			<add><![CDATA[
// Topic Fields
$txt['topic_fields'] = 'Topic Fields';
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Post.php">
		<operation>
			<search position="after"><![CDATA[// Update all the stats so everyone knows about this new topic and message.]]></search>
			<add><![CDATA[// Insert the custom fields, if any.
	if (!empty($msgOptions['custom_fields']))
	{
		$inserts = array();
		foreach ($msgOptions['custom_fields'] as $col_name => $field)
			$inserts[] = array($col_name, $field, $msgOptions['id']);

		if (!empty($inserts))
			$smcFunc['db_insert']('ignore',
				'{db_prefix}message_fields',
				array('col_name' => 'string', 'value' => 'string', 'id_msg' => 'int'),
				$inserts,
				array('id_msg_field', 'col_name', 'id_msg')
			);
	}

	]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Display.php">
		<operation>
			<search position="after"><![CDATA[// Fetch attachments.]]></search>
			<add><![CDATA[// Fetch fields.
		$request = $smcFunc['db_query']('', '
			SELECT
				f.id_msg_field, f.id_msg, f.value, c.field_name
			FROM {db_prefix}message_fields AS f
				LEFT JOIN {db_prefix}custom_fields AS c ON (c.col_name = f.col_name)
			WHERE f.id_msg IN ({array_int:message_list})',
			array(
				'message_list' => $messages,
			)
		);

		$temp_field = array();
		$fields = array();
		while ($row = $smcFunc['db_fetch_assoc']($request))
			$temp_field[$row['id_msg_field']] = $row;

		// This is better than sorting it with the query...
		ksort($temp_field);

		foreach ($temp_field as $row)
			$context['custom_fields'][$row['id_msg']][] = $row;

		]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[// Compose the memory eat- I mean message array.]]></search>
			<add><![CDATA[// Embed the custom fields into the message.
	if (!empty($context['custom_fields'][$message['id_msg']]))
	{
		$message['body'] .= '
						<br />
						<br />
						<hr />
						<dl class="settings">';

		foreach ($context['custom_fields'][$message['id_msg']] as $field)
			$message['body'] .= '
							<dt>
								<strong>' . $field['field_name'] . ': </strong><br />
							</dt>
							<dd>
								' . $field['value'] . '
							</dd>';

		$message['body'] .= '
						</dl>';
	}

	]]></add>
		</operation>
	</file>

</modification>
